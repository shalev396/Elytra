name: Frontend CI/CD

permissions:
  id-token: write
  contents: read

on:
  push:
    branches:
      - 'main' # Production
      - 'dev' # Development
      - 'qa' # QA
    paths:
      - 'client/**'
      - '.github/workflows/Frontend-CICD.yml'

jobs:
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name == 'main' && 'prod' || github.ref_name == 'dev' && 'dev' || github.ref_name == 'qa' && 'qa' }}

    env:
      # Repository variables
      AWS_REGION: ${{ vars.AWS_REGION }}

      # Repository secrets
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Set stage
        id: stage
        run: echo "name=${{ github.ref_name == 'main' && 'prod' || github.ref_name == 'dev' && 'dev' || github.ref_name == 'qa' && 'qa' }}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/my-github-actions-role

      - name: Install server dependencies
        run: npm ci
        working-directory: server

      - name: Install client dependencies
        run: npm ci
        working-directory: client

      - name: Build
        run: npm run build
        working-directory: client

      # Stack name = {appName}-{stage} from server/serverless.yml custom.appName
      # Update "elytra" below if you change custom.appName in serverless.yml
      - name: Get CloudFormation Outputs
        id: cf
        run: |
          STACK="elytra-${{ steps.stage.outputs.name }}"
          CF_ID=$(aws cloudformation describe-stacks --stack-name "$STACK" --query "Stacks[0].Outputs[?OutputKey=='CloudFrontDistributionId'].OutputValue" --output text)
          S3_BUCKET=$(aws cloudformation describe-stacks --stack-name "$STACK" --query "Stacks[0].Outputs[?OutputKey=='S3ClientBucketName'].OutputValue" --output text)
          echo "cf_id=$CF_ID" >> $GITHUB_OUTPUT
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT

      - name: Deploy to S3
        run: aws s3 sync ./client/dist s3://${{ steps.cf.outputs.s3_bucket }}/ --delete

      - name: Invalidate CloudFront
        run: aws cloudfront create-invalidation --distribution-id ${{ steps.cf.outputs.cf_id }} --paths "/*"
