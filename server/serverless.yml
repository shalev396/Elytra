# ================================
# SERVERLESS CONFIGURATION
# ================================
#
# This serverless.yml configures a complete serverless application with:
# - Lambda functions for API endpoints (bundled with serverless-esbuild)
# - S3 buckets for client files and assets
# - CloudFront distribution for global CDN
# - Route 53 for custom domain routing
# - Cognito for authentication
#
# DEPLOYMENT NOTES:
# 1. SSL Certificates - CREATE MANUALLY in ACM (us-east-1 region):
#    - Create certificate for your domain (add ARN to CERTIFICATE_ARN)
# 2. Ensure you have a Route 53 hosted zone for the domain
# 3. Deploy stages separately:
#    - DEV:  npm run deploy:dev
#    - QA:   npm run deploy:qa
#    - PROD: npm run deploy:prod
# 4. Each stage gets its own complete infrastructure:
#    - Separate CloudFront distributions with custom domains
#    - Separate S3 buckets
#    - Separate API Gateways
#    - Separate Route 53 records
#    - Separate Cognito User Pools
# 5. After deployment, upload your React build files to the stage-specific client bucket
# 6. Upload assets (images, PDFs, icons, etc.) to the stage-specific assets bucket under the /media/ path
#
# DEVELOPMENT:
#   npm run dev          - Hot-reload dev server (esbuild watches and recompiles on save)
#   npm run start        - Build with webpack, then run offline (production-like test)
#   npm run deploy:dev   - Build with webpack, then deploy to AWS
#
# ================================
org: shalev396

app: ${self:custom.appName}

service: ${self:custom.appName}

frameworkVersion: ^4.0.0

provider:
  name: aws
  stage: ${opt:stage, 'dev'}
  runtime: nodejs22.x
  timeout: 30
  memorySize: 160
  region: ${env:AWS_REGION}
  logRetentionInDays: 30

  apiGateway:
    shouldStartNameWithService: true
  logs:
    restApi: false
  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:5173
        - https://${env:DOMAIN_NAME}
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        - HEAD
      allowCredentials: true
      maxAge: 86400
    authorizers:
      cognitoAuthorizer:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl:
          Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}
        audience:
          - Ref: CognitoUserPoolClient

  environment:
    ENV: ${opt:stage, 'dev'}
    DATABASE_URL: ${env:DATABASE_URL}
    S3_ASSETS_BUCKET_NAME: ${self:custom.assetsBucketName}
    S3_CLIENT_BUCKET_NAME: ${self:custom.clientBucketName}
    COGNITO_CLIENT_ID: ${self:custom.cognitoEnv.clientId}
    COGNITO_USER_POOL_ID: ${self:custom.cognitoEnv.userPoolId}
    COGNITO_ISSUER: ${self:custom.cognitoEnv.issuer}

  iam:
    role:
      statements:
        # Cognito Permissions
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminDeleteUser
          Resource:
            - arn:aws:cognito-idp:${self:provider.region}:*:userpool/*

        # S3 Permissions - Assets bucket
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - 'arn:aws:s3:::${self:custom.assetsBucketName}/*'

# Package Configuration
package:
  individually: true

# Disable native esbuild (using serverless-esbuild plugin instead)
build:
  esbuild: false

# Serverless Plugins
plugins:
  - serverless-esbuild
  - serverless-offline
  - serverless-prune-plugin

# Custom Configuration
custom:
  appName: elytra
  appDisplayName: Elytra

  clientBucketName: ${env:DOMAIN_NAME}
  assetsBucketName: ${env:DOMAIN_NAME}-assets

  useEsbuild: ${param:use-esbuild, 'false'}

  esbuild: ${self:custom.esbuildConfig.${self:custom.useEsbuild}}

  cognitoEnv: ${self:custom.cognitoEnvConfig.${self:custom.useEsbuild}}
  cognitoEnvConfig:
    'true':
      clientId: ${env:COGNITO_CLIENT_ID, ''}
      userPoolId: ${env:COGNITO_USER_POOL_ID, ''}
      issuer: ${env:COGNITO_ISSUER, ''}
    'false':
      clientId:
        Ref: CognitoUserPoolClient
      userPoolId:
        Ref: CognitoUserPool
      issuer:
        Fn::Sub: 'https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}'

  esbuildConfig:
    'true':
      bundle: true
      minify: false
      platform: node
      target: node22
      format: esm
      outputFileExtension: '.mjs'
      # Express.js (CJS) bundled into ESM needs a real require() for dynamic node: imports
      banner:
        js: "import { createRequire } from 'module'; const require = createRequire(import.meta.url);"
      exclude:
        - '@aws-sdk/*'
        - 'aws-sdk'
      watch:
        pattern: 'src/**/*.ts'
    # Webpack mode: re-processes webpack output (bundle must be true or esbuild errors on exclude)
    'false':
      bundle: true
      minify: false
      platform: node
      target: node22
      format: esm
      outputFileExtension: '.mjs'
      resolveExtensions:
        - '.mjs'
        - '.ts'
        - '.js'
      exclude:
        - '@aws-sdk/*'
        - 'aws-sdk'

  handlerBase:
    'true': src/handlers/
    'false': build/

  viewerCertificate:
    AcmCertificateArn: ${env:CERTIFICATE_ARN}
    SslSupportMethod: sni-only
    MinimumProtocolVersion: TLSv1.2_2021

  distributionComment:
    dev: '${self:custom.appDisplayName} Development'
    qa: '${self:custom.appDisplayName} QA'
    prod: '${self:custom.appDisplayName} Production'

  serverless-offline:
    httpPort: 3000
    lambdaPort: 3002
    noPrependStageInUrl: true
    reloadHandler: true
    disableCookieValidation: true
    enforceSecureCookies: false
    printOutput: true
    noAuth: true

  prune:
    automatic: true
    number: 5
    includeLayers: true

  envFile: .env.${sls:stage}

# Lambda Functions
functions:
  # PUBLIC: Authentication & Health
  authApi:
    handler: ${self:custom.handlerBase.${self:custom.useEsbuild}}api/auth-handler.handler
    timeout: 30
    memorySize: 256
    package:
      patterns:
        - 'build/api/auth-handler.mjs'
    events:
      - httpApi:
          path: /api/auth/{proxy+}
          method: ANY

  # PRIVATE: All authenticated user operations
  userApi:
    handler: ${self:custom.handlerBase.${self:custom.useEsbuild}}api/user-handler.handler
    timeout: 30
    memorySize: 256
    package:
      patterns:
        - 'build/api/user-handler.mjs'
    events:
      - httpApi:
          path: /api/user/{proxy+}
          method: ANY
          authorizer:
            name: cognitoAuthorizer

# AWS Resources Configuration
resources:
  Description: ${self:custom.appDisplayName} full-stack application — Lambda API, S3-hosted client, CloudFront CDN, Route 53 DNS, and Cognito authentication (${self:provider.stage})
  Resources:
    # ================================
    # S3 BUCKETS CONFIGURATION
    # ================================

    # S3 Bucket for Client Files (React Vite Build)
    ClientFilesBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.clientBucketName}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        WebsiteConfiguration:
          IndexDocument: index.html
          ErrorDocument: index.html
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldVersions
              Status: Enabled
              NoncurrentVersionExpirationInDays: 30
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders: ['*']
              AllowedMethods: [GET, HEAD]
              AllowedOrigins: ['*']
              MaxAge: 3600

    # S3 Bucket Policy for Client Files
    ClientFilesBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket:
          Ref: ClientFilesBucket
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Sid: PublicReadGetObject
              Effect: Allow
              Principal: '*'
              Action: s3:GetObject
              Resource:
                - Fn::Join:
                    - ''
                    - - 'arn:aws:s3:::'
                      - Ref: ClientFilesBucket
                      - '/*'

    # S3 Bucket for Assets/Images
    AssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.assetsBucketName}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldVersions
              Status: Enabled
              NoncurrentVersionExpirationInDays: 30
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders: ['*']
              AllowedMethods: [GET, HEAD, PUT, POST, DELETE]
              AllowedOrigins: ['*']
              MaxAge: 3600

    # S3 Bucket Policy for Assets
    AssetsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket:
          Ref: AssetsBucket
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Sid: PublicReadGetObject
              Effect: Allow
              Principal: '*'
              Action: s3:GetObject
              Resource:
                - Fn::Join:
                    - ''
                    - - 'arn:aws:s3:::'
                      - Ref: AssetsBucket
                      - '/*'

    # ================================
    # CLOUDFRONT DISTRIBUTION
    # ================================

    CloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Comment: ${self:custom.distributionComment.${self:provider.stage}}
          Enabled: true

          Aliases:
            - ${env:DOMAIN_NAME}

          ViewerCertificate: ${self:custom.viewerCertificate}

          # Default: serves React app from S3
          DefaultCacheBehavior:
            TargetOriginId: ClientFilesOrigin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods: [GET, HEAD, OPTIONS]
            CachedMethods: [GET, HEAD, OPTIONS]
            Compress: true
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad # Managed-CachingDisabled
            OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf # Managed-CORS-S3Origin

          CacheBehaviors:
            # API Gateway behavior - /api/* routes to API Gateway
            - PathPattern: '/api/*'
              TargetOriginId: ApiGatewayOrigin
              ViewerProtocolPolicy: redirect-to-https
              AllowedMethods: [DELETE, GET, HEAD, OPTIONS, PATCH, POST, PUT]
              CachedMethods: [GET, HEAD, OPTIONS]
              Compress: true
              CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad # Managed-CachingDisabled
              OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac # Managed-AllViewerExceptHostHeader

            # Assets behavior - /media/* routes to assets bucket (images, PDFs, icons, etc.)
            - PathPattern: '/media/*'
              TargetOriginId: AssetsOrigin
              ViewerProtocolPolicy: redirect-to-https
              AllowedMethods: [GET, HEAD, OPTIONS]
              CachedMethods: [GET, HEAD, OPTIONS]
              Compress: true
              CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6 # Managed-CachingOptimized
              OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf # Managed-CORS-S3Origin

          Origins:
            # Origin for React app files (S3 bucket)
            - Id: ClientFilesOrigin
              DomainName:
                Fn::GetAtt:
                  - ClientFilesBucket
                  - RegionalDomainName
              S3OriginConfig:
                OriginAccessIdentity: ''

            # Origin for assets (S3 bucket — images, PDFs, icons, etc.)
            - Id: AssetsOrigin
              DomainName:
                Fn::GetAtt:
                  - AssetsBucket
                  - RegionalDomainName
              S3OriginConfig:
                OriginAccessIdentity: ''

            # Origin for API Gateway
            - Id: ApiGatewayOrigin
              DomainName:
                Fn::Sub: '${HttpApi}.execute-api.${AWS::Region}.amazonaws.com'
              CustomOriginConfig:
                HTTPPort: 443
                HTTPSPort: 443
                OriginProtocolPolicy: https-only
                OriginSSLProtocols: [TLSv1.2]

          # SPA routing: redirect 403/404 to index.html
          CustomErrorResponses:
            - ErrorCode: 403
              ResponseCode: 200
              ResponsePagePath: /index.html
              ErrorCachingMinTTL: 300
            - ErrorCode: 404
              ResponseCode: 200
              ResponsePagePath: /index.html
              ErrorCachingMinTTL: 300

          PriceClass: PriceClass_All
          HttpVersion: http2
          IPV6Enabled: true

    # ================================
    # ROUTE 53 CONFIGURATION
    # ================================

    Route53Record:
      Type: AWS::Route53::RecordSet
      Properties:
        HostedZoneId: ${env:HOSTED_ZONE_ID}
        Name: ${env:DOMAIN_NAME}
        Type: A
        AliasTarget:
          DNSName:
            Fn::GetAtt:
              - CloudFrontDistribution
              - DomainName
          HostedZoneId: Z2FDTNDATAQYW2 # CloudFront hosted zone ID (global constant)
          EvaluateTargetHealth: false

    # ================================
    # COGNITO USER POOL
    # ================================

    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:custom.appName}-${self:provider.stage}
        UserPoolTier: ESSENTIALS
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Schema:
          - Name: email
            AttributeDataType: String
            Required: true
            Mutable: false
          - Name: name
            AttributeDataType: String
            Required: false
            Mutable: true
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireUppercase: true
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: true
        EmailConfiguration:
          EmailSendingAccount: COGNITO_DEFAULT
        VerificationMessageTemplate:
          DefaultEmailOption: CONFIRM_WITH_CODE
          EmailSubject: '${self:custom.appDisplayName} — Verify your email'
          EmailMessage: 'Your ${self:custom.appDisplayName} verification code is {####}. This code expires in 24 hours.'
        AccountRecoverySetting:
          RecoveryMechanisms:
            - Name: verified_email
              Priority: 1
        UserPoolAddOns:
          AdvancedSecurityMode: OFF

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:custom.appName}-${self:provider.stage}-client
        UserPoolId:
          Ref: CognitoUserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH
        PreventUserExistenceErrors: ENABLED
        EnableTokenRevocation: true
        AccessTokenValidity: 1
        IdTokenValidity: 1
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: hours
          IdToken: hours
          RefreshToken: days
        ReadAttributes:
          - email
          - name
          - email_verified
        WriteAttributes:
          - email
          - name

  Outputs:
    CognitoUserPoolId:
      Description: Cognito User Pool ID
      Value:
        Ref: CognitoUserPool
      Export:
        Name: ${self:custom.appName}-${self:provider.stage}-UserPoolId

    CognitoClientId:
      Description: Cognito User Pool Client ID
      Value:
        Ref: CognitoUserPoolClient
      Export:
        Name: ${self:custom.appName}-${self:provider.stage}-ClientId

    CognitoIssuer:
      Description: Cognito Token Issuer URL
      Value:
        Fn::Sub: https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}
      Export:
        Name: ${self:custom.appName}-${self:provider.stage}-Issuer

    CloudFrontDistributionId:
      Description: CloudFront Distribution ID for cache invalidation
      Value:
        Ref: CloudFrontDistribution
      Export:
        Name: ${self:custom.appName}-${self:provider.stage}-CloudFrontDistributionId

    S3ClientBucketName:
      Description: S3 Client Bucket Name for frontend deployment
      Value:
        Ref: ClientFilesBucket
      Export:
        Name: ${self:custom.appName}-${self:provider.stage}-S3ClientBucketName

    S3AssetsBucketName:
      Description: S3 Assets Bucket Name
      Value:
        Ref: AssetsBucket
      Export:
        Name: ${self:custom.appName}-${self:provider.stage}-S3AssetsBucketName
